Bootstrap: localimage
From: /tmp/base.sif

%files
    /tmp/repo.tar.gz /tmp/repo.tar.gz

%post
    cd /
    tar -xzf /tmp/repo.tar.gz
    mkdir -p /app
    cd /app
    
    # Extract assassyn main repo archive
    tar -xzf /assassyn-*.tar.gz --strip-components=1
    
    # Extract submodule archives to their correct locations
    tar -xzf ../3rd-party/ramulator2-*.tar.gz -C 3rd-party/
    tar -xzf ../3rd-party/circt-*.tar.gz -C 3rd-party/
    tar -xzf ../3rd-party/verilator-*.tar.gz -C 3rd-party/
    
    # Clean up archive files
    rm -f /assassyn-*.tar.gz
    rm -f /3rd-party/*-*.tar.gz
    rm -rf examples/ docs/ tutorials/

    # Remove existing venv and create fresh one for container
    rm -rf /app/.assassyn-venv
    python3 -m venv /app/.assassyn-venv
    /app/.assassyn-venv/bin/pip install --upgrade pip
    /app/.assassyn-venv/bin/pip install build
    /app/.assassyn-venv/bin/pip install -r /app/python/requirements.txt

%runscript
    exec "\$@"

%test
    #!/bin/zsh
    echo "=== Testing repo container ==="
    cd /app
    echo "Checking repository structure..."
    ls -la
    
    echo "=== Checking submodules ==="
    echo "Checking 3rd-party directory..."
    ls -la 3rd-party/
    
    # Check circt submodule
    echo "=== Checking circt submodule ==="
    if [ -d "3rd-party/circt" ]; then
        echo "✓ circt directory exists"
        echo "circt contents:"
        ls -la 3rd-party/circt/ | head -10
        
        # Check if circt is not empty
        if [ "$(ls -A 3rd-party/circt)" ]; then
            echo "✓ circt submodule is not empty"
        else
            echo "✗ ERROR: circt submodule is empty"
            exit 1
        fi
        
        # Check circt llvm submodule
        echo "=== Checking circt llvm submodule ==="
        if [ -d "3rd-party/circt/llvm" ]; then
            echo "✓ circt/llvm directory exists"
            echo "circt/llvm contents:"
            ls -la 3rd-party/circt/llvm/ | head -10
            
            # Check if llvm is not empty
            if [ "$(ls -A 3rd-party/circt/llvm)" ]; then
                echo "✓ circt/llvm submodule is not empty"
            else
                echo "✗ ERROR: circt/llvm submodule is empty"
                exit 1
            fi
        else
            echo "✗ ERROR: circt/llvm directory does not exist"
            exit 1
        fi
    else
        echo "✗ ERROR: circt directory does not exist"
        exit 1
    fi
    
    # Check verilator submodule
    echo "=== Checking verilator submodule ==="
    if [ -d "3rd-party/verilator" ]; then
        echo "✓ verilator directory exists"
        echo "verilator contents:"
        ls -la 3rd-party/verilator/ | head -10
        
        # Check if verilator is not empty
        if [ "$(ls -A 3rd-party/verilator)" ]; then
            echo "✓ verilator submodule is not empty"
        else
            echo "✗ ERROR: verilator submodule is empty"
            exit 1
        fi
    else
        echo "✗ ERROR: verilator directory does not exist"
        exit 1
    fi
    
    # Check ramulator2 submodule
    echo "=== Checking ramulator2 submodule ==="
    if [ -d "3rd-party/ramulator2" ]; then
        echo "✓ ramulator2 directory exists"
        echo "ramulator2 contents:"
        ls -la 3rd-party/ramulator2/ | head -10
        
        # Check if ramulator2 is not empty
        if [ "$(ls -A 3rd-party/ramulator2)" ]; then
            echo "✓ ramulator2 submodule is not empty"
        else
            echo "✗ ERROR: ramulator2 submodule is empty"
            exit 1
        fi
    else
        echo "✗ ERROR: ramulator2 directory does not exist"
        exit 1
    fi
    
    echo "=== All submodule checks passed ==="
    echo "Repo container test completed successfully."
