Bootstrap: localimage
From: assassyn-base.sif

%arguments
    REPO_URL=https://github.com/Synthesys-Lab/assassyn
    REPO_TAG=master

%post
    # Clone repository from specified URL and tag/branch/commit
    git clone --recursive {{ REPO_URL }} /app
    cd /app
    git checkout {{ REPO_TAG }}
    
    # Remove unnecessary directories to reduce image size
    rm -rf examples/ docs/ tutorials/
    
    # Set up environment
    PYTHON_VERSION=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
    
    cat >> $APPTAINER_ENVIRONMENT <<EOF
export ASSASSYN_HOME="/app"
export VERILATOR_ROOT="/app/3rd-party/verilator"
export PYTHONPATH="/app/python:/app/.local/lib/python${PYTHON_VERSION}/site-packages:\$PYTHONPATH"
export PATH="/app/3rd-party/verilator/bin:/app/.local/bin:\$PATH"
export CC="ccache gcc"
export CXX="ccache g++"
export CCACHE_DIR="/tmp/ccache"
export PYTHONUSERBASE="/app/.local"
export CARGO_HOME="/tmp/cargo"
export CARGO_TARGET_DIR="/app/.sim-runtime-cache"
EOF

    # Make repo write-able
    chmod -R u+w /app

    # Build the project
    make build-all

%runscript
    exec "$@"

%test
    #!/bin/zsh
    echo "=== Testing repository build ==="
    echo "Repository: {{ REPO_URL }} at {{ REPO_TAG }}"
    cd /app
    python -c 'import assassyn' # import this module
    echo "Import test: $?"
    
    make test-all
