Bootstrap: localimage
From: /tmp/repo.sif

%post
    /bin/zsh << ZSHEOF
cd /app

# Remove existing venv and create fresh one for container
rm -rf /app/.assassyn-venv
python3 -m venv /app/.assassyn-venv
/app/.assassyn-venv/bin/pip install --upgrade pip
/app/.assassyn-venv/bin/pip install build
/app/.assassyn-venv/bin/pip install -r /app/python/requirements.txt

# Source the virtual environment
source /app/.assassyn-venv/bin/activate

# Manually export environment variables (from setup.sh)
export PYTHONPATH="/app/python:\$PYTHONPATH"
export ASSASSYN_HOME="/app"
export VERILATOR_ROOT="/app/3rd-party/verilator"
export PATH="\$VERILATOR_ROOT/bin:\$PATH"
export CARGO_TARGET_DIR="/app/.sim-runtime-cache"

# Clean and rebuild components in correct order for Linux container
make clean-wrapper
make clean-ramulator2
make build-ramulator2
make build-wrapper

# Add PyCDE to PYTHONPATH if it exists
if [ -d "/app/3rd-party/circt/frontends/PyCDE/dist/lib" ]; then
  export PYTHONPATH="/app/3rd-party/circt/frontends/PyCDE/dist/lib:\$PYTHONPATH"
fi


cat >> \$APPTAINER_ENVIRONMENT <<EOF
export RUSTC_WRAPPER="\$RUSTC_WRAPPER"
export ASSASSYN_HOME="\$ASSASSYN_HOME"
export VERILATOR_ROOT="\$VERILATOR_ROOT"
export PYTHONPATH="\$PYTHONPATH"
export CC="ccache gcc"
export CXX="ccache g++"
export CCACHE_DIR="/tmp/ccache"
export CARGO_HOME="/tmp/cargo"
export VIRTUAL_ENV="/app/.assassyn-venv"
export PATH="/app/.assassyn-venv/bin:\$PATH"
EOF
ZSHEOF

%runscript
    exec "\$@"

%test
    #!/bin/zsh
    echo "=== Testing builds ==="
    cd /app
    echo "Testing basic Python import..."
    python -c 'import sys; print(f"Python {sys.version}")'
    echo "Testing assassyn core modules..."