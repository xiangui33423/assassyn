Bootstrap: localimage
From: /tmp/repo.sif

%post
    /bin/zsh << ZSHEOF
cd /app

# Source the virtual environment
source /app/.assassyn-venv/bin/activate

# Manually export environment variables (from setup.sh)
export PYTHONPATH="/app/python:\$PYTHONPATH"
export ASSASSYN_HOME="/app"
export VERILATOR_ROOT="/app/3rd-party/verilator"
export PATH="\$VERILATOR_ROOT/bin:\$PATH"
export CARGO_TARGET_DIR="/app/.sim-runtime-cache"

# Clean and rebuild components in correct order for Linux container
make build-verilator
make build-ramulator2
make build-wrapper

# Set fallback version for CIRCT setuptools-scm when git metadata is unavailable
export SETUPTOOLS_SCM_PRETEND_VERSION="0.0.0"
export SETUPTOOLS_SCM_PRETEND_VERSION_FOR_PYCDE="0.0.0"
SETUPTOOLS_SCM_PRETEND_VERSION="0.0.0" SETUPTOOLS_SCM_PRETEND_VERSION_FOR_PYCDE="0.0.0" make install-circt

# Add PyCDE to PYTHONPATH if it exists
if [ -d "/app/3rd-party/circt/frontends/PyCDE/dist/lib" ]; then
  export PYTHONPATH="/app/3rd-party/circt/frontends/PyCDE/dist/lib:\$PYTHONPATH"
fi


cat >> \$APPTAINER_ENVIRONMENT <<EOF
export RUSTC_WRAPPER="\$RUSTC_WRAPPER"
export ASSASSYN_HOME="\$ASSASSYN_HOME"
export VERILATOR_ROOT="\$VERILATOR_ROOT"
export PYTHONPATH="\$PYTHONPATH"
export CC="gcc"
export CXX="g++"
export CCACHE_DIR="/tmp/ccache"
export CARGO_HOME="/tmp/cargo"
export VIRTUAL_ENV="/app/.assassyn-venv"
export PATH="/app/.assassyn-venv/bin:\$VERILATOR_ROOT/bin:\$PATH"
export SETUPTOOLS_SCM_PRETEND_VERSION="0.0.0"
export SETUPTOOLS_SCM_PRETEND_VERSION_FOR_PYCDE="0.0.0"
EOF
ZSHEOF

%runscript
    exec "\$@"

%test
    #!/bin/zsh
    echo "=== Testing builds ==="
    cd /app
    echo "Testing basic Python import..."
    /app/.assassyn-venv/bin/python -c 'import sys; print(f"Python {sys.version}")'
    
    echo "Testing PyCDE import..."
    if /app/.assassyn-venv/bin/python -c 'import pycde'; then
        echo "✓ PyCDE import successful"
    else
        echo "✗ ERROR: PyCDE import failed"
        exit 1
    fi
    
    echo "Testing Verilator installation..."
    if [ -x "/app/3rd-party/verilator/bin/verilator" ]; then
        /app/3rd-party/verilator/bin/verilator --version
        echo "✓ Verilator is installed and working"
    else
        echo "✗ ERROR: Verilator binary not found at /app/3rd-party/verilator/bin/verilator"
        exit 1
    fi
    echo "Testing assassyn core modules..."