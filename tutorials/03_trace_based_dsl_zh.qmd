---
title: "ç†è§£ Assassyn çš„ Trace-based DSL"
format:
  html:
    toc: true
    toc-depth: 3
    mermaid:
      theme: default
      themeVariables:
        clusterBkg: "#f8fafc"
        clusterBorder: "#cbd5e1"
        primaryColor: "#ffffff"
        primaryTextColor: "#0f172a"
        lineColor: "#475569"

---

# Tutorial: ç†è§£ Assassyn çš„ Trace-based DSL

> **ä½œè€…:** Claude (Anthropic)
> **æ—¥æœŸ:** 2025.10.13
>

## 1. å¼•è¨€

### 1.1 ä»€ä¹ˆæ˜¯ Trace-based DSL?

Assassyn é‡‡ç”¨äº†ä¸€ç§åµŒå…¥åœ¨ Python ä¸­çš„ trace-based DSL (é¢†åŸŸç‰¹å®šè¯­è¨€)ã€‚ä¸ä¼ ç»Ÿçš„ parser-based frontend ä¸åŒ,trace-based DSL é€šè¿‡è¿ç®—ç¬¦é‡è½½æ¥æ„å»ºç¡¬ä»¶æè¿°çš„æŠ½è±¡è¯­æ³•æ ‘ (AST)ã€‚

**æ ¸å¿ƒæ€æƒ³:**
- åœ¨ tracing ä½œç”¨åŸŸå†…,æ‰€æœ‰æ“ä½œéƒ½è¢«é‡è½½
- `a + b` ä¸æ˜¯è®¡ç®—åŠ æ³•ç»“æœ,è€Œæ˜¯åˆ›å»ºä¸€ä¸ª `Add` èŠ‚ç‚¹å¹¶åŠ å…¥åˆ°å½“å‰çš„æ’å…¥ç‚¹
- Python ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯æ„å»º IR çš„è¿‡ç¨‹

### 1.2 ä¸ºä»€ä¹ˆä½¿ç”¨ Trace-based DSL?

```{mermaid}
flowchart LR
    A[Parser-based<br/>éœ€è¦å¼€å‘è§£æå™¨] -->|å¤æ‚| B[ç»´æŠ¤æˆæœ¬é«˜]
    C[Trace-based<br/>åµŒå…¥ Python] -->|ç®€å•| D[åˆ©ç”¨ Python è¯­æ³•]
    D --> E[è¿ç®—ç¬¦é‡è½½<br/>æ„å»º IR]

    style C fill:#e8f5e9
    style D fill:#e8f5e9
    style E fill:#e8f5e9
```

**ä¼˜åŠ¿:**
- æ— éœ€å¼€å‘å’Œç»´æŠ¤å¤æ‚çš„è§£æå™¨
- å……åˆ†åˆ©ç”¨ Python çš„è¯­æ³•å’Œå·¥å…·é“¾
- å¼€å‘æ•ˆç‡é«˜,è°ƒè¯•æ–¹ä¾¿

---

## 2. Python `if` vs Assassyn `Condition`: æ ¸å¿ƒåŒºåˆ«

è¿™æ˜¯ç†è§£ trace-based DSL æœ€é‡è¦çš„æ¦‚å¿µã€‚

### 2.1 æ¦‚å¿µå¯¹æ¯”

| ç‰¹æ€§ | Python `if` | Assassyn `Condition` |
|------|------------|---------------------|
| æ±‚å€¼æ—¶æœº | ç¼–è¯‘æ—¶ (Python è¿è¡Œæ—¶) | ç¡¬ä»¶è¿è¡Œæ—¶ |
| ä½œç”¨ | æ§åˆ¶ trace è·¯å¾„,æ¡ä»¶ç¼–è¯‘ | ç”Ÿæˆç¡¬ä»¶æ¡ä»¶é€»è¾‘ |
| æ¡ä»¶è¡¨è¾¾å¼ | Python è¡¨è¾¾å¼ (bool) | Assassyn IR å€¼ (Bits/UInt) |
| ç”Ÿæˆç¡¬ä»¶ | ä¸ç”Ÿæˆ,ç›´æ¥é€‰æ‹©åˆ†æ”¯ | ç”Ÿæˆ mux å’Œæ¡ä»¶å— |
| ç±»æ¯” | C/C++ çš„ `#if` é¢„å¤„ç† | Verilog çš„ `if` è¯­å¥ |

```{mermaid}
flowchart TD
    subgraph PythonIf["Python if (ç¼–è¯‘æ—¶)"]
        A1[Python è¿è¡Œæ—¶<br/>è¯„ä¼°æ¡ä»¶] --> B1{æ¡ä»¶ä¸ºçœŸ?}
        B1 -->|æ˜¯| C1[trace åˆ†æ”¯ 1<br/>æ„å»ºå¯¹åº” IR]
        B1 -->|å¦| D1[trace åˆ†æ”¯ 2<br/>æ„å»ºå¯¹åº” IR]
    end

    subgraph AssasynCond["Assassyn Condition (è¿è¡Œæ—¶)"]
        A2[æ„å»º IR é˜¶æ®µ] --> B2[åˆ›å»º CondBlock]
        B2 --> C2[ç”Ÿæˆç¡¬ä»¶ mux]
        C2 --> D2[ç¡¬ä»¶è¿è¡Œæ—¶<br/>è¯„ä¼°æ¡ä»¶]
    end

    style PythonIf fill:#fff3e0
    style AssasynCond fill:#e3f2fd
```

### 2.2 å®æˆ˜å¯¹æ¯”:çœ‹çœ‹ç”Ÿæˆçš„ IR

è®©æˆ‘ä»¬é€šè¿‡å®é™…ä»£ç æ¥çœ‹çœ‹ä¸¤è€…çš„æœ¬è´¨åŒºåˆ«ã€‚**é‡ç‚¹è§‚å¯Ÿç”Ÿæˆçš„ IR ç»“æ„**ã€‚

```{python}
#| code-fold: false

import warnings
warnings.filterwarnings("ignore")

import sys
import os
lib_path = os.path.abspath(os.path.join(os.path.dirname("03_trace_based_dsl_zh.qmd"), '../python/'))
sys.path.append(lib_path)
from function_t import run_quietly, build_and_show_ir, generate_and_show_verilog

from assassyn.frontend import *
from assassyn.backend import elaborate
from assassyn import utils
import assassyn

print("âœ… ç¯å¢ƒé…ç½®å®Œæˆ")
```

#### ç¤ºä¾‹ 1: Python `if` - æ¡ä»¶ç¼–è¯‘

å½“æˆ‘ä»¬ä½¿ç”¨ Python `if` æ—¶,ä¸åŒçš„åˆ†æ”¯ä¼šç”Ÿæˆå®Œå…¨ä¸åŒçš„ç¡¬ä»¶:

```{python}
#| code-fold: false

ENABLE_FEATURE = True  # å°è¯•æ”¹ä¸º False è§‚å¯Ÿç”Ÿæˆä»£ç çš„å˜åŒ–

class PythonIfExample(Module):
    """å±•ç¤º Python if çš„æ¡ä»¶ç¼–è¯‘"""

    def __init__(self):
        super().__init__(ports={})

    @module.combinational
    def build(self):
        counter = RegArray(UInt(32), 1)
        counter[0] = counter[0] + UInt(32)(1)

        if ENABLE_FEATURE:
            # å½“ ENABLE_FEATURE=True æ—¶,è¿™ä¸ªåˆ†æ”¯è¢« trace
            result = counter[0] * UInt(32)(2)
            log("Feature enabled: result = {}", result)
        else:
            # å½“ ENABLE_FEATURE=False æ—¶,è¿™ä¸ªåˆ†æ”¯è¢« trace
            result = counter[0] + UInt(32)(10)
            log("Feature disabled: result = {}", result)

# æ„å»ºå¹¶æ˜¾ç¤º IR
sys1 = build_and_show_ir(PythonIfExample, f'python_if_demo (ENABLE={ENABLE_FEATURE})')

# ç”Ÿæˆ Verilog (å¯é€‰)
verilog_path1 = generate_and_show_verilog(sys1)
```

**ğŸ” å…³é”®è§‚å¯Ÿ (çœ‹ä¸Šé¢çš„ IR è¾“å‡º):** <br>
- âœ… IR ä¸­ç›´æ¥åŒ…å« `result = counter_rd * (2:u32)` (ä¹˜æ³•) <br>
- âŒ IR ä¸­**ä¸å­˜åœ¨**åŠ æ³•é€»è¾‘ `counter + 10`<br>
- âŒ IR ä¸­**æ²¡æœ‰** `when` æ¡ä»¶å—<br>
- ğŸ’¡ åªæœ‰ä¸€ä¸ªåˆ†æ”¯è¢« trace,ç¡¬ä»¶ç»“æ„åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†

**ğŸ“Œ é‡ç‚¹:** å› ä¸º `ENABLE_FEATURE=True`,Python åªæ‰§è¡Œäº† `if` çš„ True åˆ†æ”¯,æ‰€ä»¥ `else` åˆ†æ”¯çš„ä»£ç æ ¹æœ¬æ²¡æœ‰è¢« trace,ç”Ÿæˆçš„ IR é‡Œåªæœ‰ä¹˜æ³•,æ²¡æœ‰åŠ æ³•!

#### ç¤ºä¾‹ 2: Assassyn `Condition` - ç¡¬ä»¶æ¡ä»¶

ç°åœ¨ä½¿ç”¨ `Condition`,ä»£ç ä¼šç”Ÿæˆç¡¬ä»¶æ¡ä»¶åˆ¤æ–­é€»è¾‘:

```{python}
#| code-fold: false

class ConditionExample(Module):
    """å±•ç¤º Assassyn Condition çš„ç¡¬ä»¶æ¡ä»¶"""

    def __init__(self):
        super().__init__(ports={})

    @module.combinational
    def build(self):
        counter = RegArray(UInt(32), 1)
        counter[0] = counter[0] + UInt(32)(1)

        # enable æ˜¯ä¸€ä¸ªç¡¬ä»¶ä¿¡å· (Bits ç±»å‹)
        enable = counter[0] < UInt(32)(50)

        with Condition(enable):
            # è¿™æ®µä»£ç æ€»æ˜¯è¢« trace,ç”Ÿæˆçš„ç¡¬ä»¶åœ¨ enable ä¸ºçœŸæ—¶æ‰æ‰§è¡Œ
            result = counter[0] * UInt(32)(2)
            log("Counter active: result = {}", result)

# æ„å»ºå¹¶æ˜¾ç¤º IR
sys2 = build_and_show_ir(ConditionExample, 'condition_demo')

# ç”Ÿæˆ Verilog (å¯é€‰)
verilog_path2 = generate_and_show_verilog(sys2)
```

**ğŸ” å…³é”®è§‚å¯Ÿ (çœ‹ä¸Šé¢çš„ IR è¾“å‡º):**<br>
- âœ… IR ä¸­åŒ…å« `when enable { ... }` æ¡ä»¶å—<br>
- âœ… ä¹˜æ³•è¿ç®—åœ¨ `when` å—**å†…éƒ¨**<br>
- âœ… ç”Ÿæˆäº† `enable = counter_rd < (50:u32)` æ¡ä»¶ä¿¡å·<br>
- ğŸ’¡ æ‰€æœ‰ä»£ç éƒ½è¢« trace,ç¡¬ä»¶åœ¨è¿è¡Œæ—¶æ ¹æ®ä¿¡å·åŠ¨æ€åˆ¤æ–­

**ğŸ“Œ é‡ç‚¹:** ä½¿ç”¨ `with Condition(enable)`,Python æŠŠæ•´ä¸ª `with` å—éƒ½ trace äº†,ç”Ÿæˆçš„ IR åŒ…å«å®Œæ•´çš„ `when enable { ... }` æ¡ä»¶ç»“æ„,ç¡¬ä»¶ä¼šåœ¨è¿è¡Œæ—¶åˆ¤æ–­!

#### å¯¹æ¯”æ€»ç»“

```{python}
print("\n" + "="*60)
print("ğŸ“Š IR å¯¹æ¯”æ€»ç»“")
print("="*60)
print("\n1ï¸âƒ£  Python if (ENABLE_FEATURE=True):")
print("   âœ“ ç›´æ¥ç”Ÿæˆ: result = counter * 2")
print("   âœ— æ— æ¡ä»¶å—: æ²¡æœ‰ when")
print("   â†’ ç¼–è¯‘æ—¶é€‰æ‹©åˆ†æ”¯,ç¡¬ä»¶å›ºå®š\n")

print("2ï¸âƒ£  Assassyn Condition (enable ä¿¡å·):")
print("   âœ“ ç”Ÿæˆæ¡ä»¶: enable = counter < 50")
print("   âœ“ æ¡ä»¶å—:   when enable { result = ... }")
print("   â†’ è¿è¡Œæ—¶åŠ¨æ€åˆ¤æ–­,ç¡¬ä»¶å¯åˆ‡æ¢\n")

print("ğŸ’¡ ç±»æ¯”:")
print("   Python if    â†â†’ C çš„ #if é¢„å¤„ç†å™¨")
print("   Condition    â†â†’ Verilog çš„ if è¯­å¥")
print("="*60)
```

---

## 3. å®Œæ•´ç¤ºä¾‹:æ¡ä»¶è®¡æ•°å™¨æ¨¡å—

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥æ¼”ç¤ºä¸¤ç§æ–¹å¼çš„æ··åˆä½¿ç”¨ã€‚

### 3.1 ç¤ºä¾‹:æ··åˆä½¿ç”¨ `if` å’Œ `Condition`

```{python}
#| code-fold: false

# Python å¸¸é‡ - ç”¨äºæ¡ä»¶ç¼–è¯‘
DEBUG_MODE = True
MAX_COUNT = 10

class ConditionalCounter(Module):
    """æ¼”ç¤º Python if å’Œ Assassyn Condition çš„åŒºåˆ«"""

    def __init__(self):
        super().__init__(
            ports={
                'enable': Port(Bits(1)),  # ç¡¬ä»¶è¾“å…¥ä¿¡å·
            }
        )

    @module.combinational
    def build(self):
        enable = self.pop_all_ports(True)
        counter = RegArray(UInt(32), 1)

        # Python if: æ¡ä»¶ç¼–è¯‘ - åœ¨ Python è¿è¡Œæ—¶å†³å®š
        if MAX_COUNT == 10:
            # å› ä¸º MAX_COUNT == 10,è¿™ä¸ªåˆ†æ”¯è¢« trace
            threshold = UInt(32)(10)
            log("[Compiled] Using threshold: 10")
        else:
            # è¿™ä¸ªåˆ†æ”¯ä¸ä¼šè¢« trace
            threshold = UInt(32)(20)
            log("[Compiled] Using threshold: 20")

        # ç¡¬ä»¶æ¡ä»¶ 1: æ£€æŸ¥è®¡æ•°å™¨æ˜¯å¦å°äºé˜ˆå€¼
        not_reached = counter[0] < threshold

        with Condition(not_reached):
            # è¿™æ®µä»£ç æ€»æ˜¯è¢« trace,ä½†ç¡¬ä»¶è¿è¡Œæ—¶æ‰åˆ¤æ–­
            counter[0] = counter[0] + UInt(32)(1)

        # ç¡¬ä»¶æ¡ä»¶ 2: æ£€æŸ¥å¤–éƒ¨ enable ä¿¡å·
        with Condition(enable[0:0]):
            # åªæœ‰å½“ enable ä¸ºé«˜ç”µå¹³æ—¶æ‰æ‰§è¡Œ
            log("[Runtime] Counter is enabled: {}", counter[0])

        # Python if: æ¡ä»¶ç¼–è¯‘ - è°ƒè¯•æ¨¡å¼
        if DEBUG_MODE:
            # å› ä¸º DEBUG_MODE ä¸º True,è¿™æ®µä»£ç è¢«åŒ…å«åœ¨ç¡¬ä»¶ä¸­
            log("[Debug] Counter={}, not_reached={}", counter[0], not_reached)

print("ConditionalCounter æ¨¡å—å®šä¹‰å®Œæˆ")
```

### 3.2 é©±åŠ¨æ¨¡å—

```{python}
#| code-fold: false

class Driver(Module):
    """é©±åŠ¨ ConditionalCounter æ¨¡å—"""

    def __init__(self):
        super().__init__(ports={})

    @module.combinational
    def build(self, counter_module: ConditionalCounter):
        cycle_cnt = RegArray(UInt(32), 1)
        cycle_cnt[0] = cycle_cnt[0] + UInt(32)(1)

        # Python if: æ ¹æ®å‘¨æœŸæ•°å†³å®š enable ä¿¡å·çš„ç”Ÿæˆæ–¹å¼
        if True:  # å¯ä»¥æ”¹ä¸º False çœ‹çœ‹æ•ˆæœ
            # å¥‡æ•°å‘¨æœŸ enable ä¸º 1
            enable_signal = cycle_cnt[0][0:0]
        else:
            # æ€»æ˜¯ enable
            enable_signal = Bits(1)(1)

        # è°ƒç”¨è®¡æ•°å™¨æ¨¡å— (ç¡¬ä»¶è¿è¡Œæ—¶)
        cond = cycle_cnt[0] < UInt(32)(30)
        with Condition(cond):
            counter_module.async_called(enable=enable_signal)

print("Driver æ¨¡å—å®šä¹‰å®Œæˆ")
```

### 3.3 ç³»ç»Ÿæ„å»ºå’Œä»¿çœŸ

```{python}
# | output-fold: true

print("å¼€å§‹æ„å»ºç³»ç»Ÿ...")

# 1. æ„å»ºç³»ç»Ÿ
sys_build = SysBuilder("trace_dsl_demo")
with sys_build:
    counter = ConditionalCounter()
    counter.build()

    driver = Driver()
    driver.build(counter)

print(sys_build)

# 2. é…ç½®ä»¿çœŸå‚æ•°
config = assassyn.backend.config(
    verilog=utils.has_verilator(), sim_threshold=100, idle_threshold=100, random=False
)


# 3. ç”Ÿæˆä»¿çœŸå™¨
def generate_simulator():
    return elaborate(sys_build, **config)


(simulator_path, verilator_path), _, _ = run_quietly(generate_simulator)
print("ä»¿çœŸå™¨ç”Ÿæˆå®Œæˆ")


# 4. è¿è¡Œä»¿çœŸ
def run_sim():
    return utils.run_simulator(simulator_path)


raw, _, _ = run_quietly(run_sim)

print("\n=== ä»¿çœŸè¾“å‡º (å‰ 20 è¡Œ) ===")
lines = raw.split("\n")
for i, line in enumerate(lines[:20]):
    if line.strip():
        print(line)

print(f"\næ€»å…±è¾“å‡º {len([l for l in lines if l.strip()])} è¡Œ")
```

---

## 4. æ·±å…¥ç†è§£:`@rewrite_assign` è£…é¥°å™¨

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ `@rewrite_assign`?

Python çš„èµ‹å€¼è¯­å¥ `a = b` æ— æ³•è¢«é‡è½½,è¿™ç»™ trace-based DSL å¸¦æ¥äº†å˜é‡å‘½åçš„é—®é¢˜ã€‚

```python
# é—®é¢˜:æ— æ³•ä» IR ä¸­è·å–å˜é‡å "result"
result = a + b  # Python èµ‹å€¼æ— æ³•è¢«é‡è½½
```

### 4.2 `@rewrite_assign` çš„å·¥ä½œåŸç†

```{mermaid}
flowchart LR
    A[åŸå§‹ Python ä»£ç <br/>result = a + b] --> B[AST è§£æ]
    B --> C[AST è½¬æ¢]
    C --> D[é‡å†™åä»£ç <br/>result = __assassyn_assignment__<br/>'result', a + b]
    D --> E[å‘½åç³»ç»Ÿå¤„ç†<br/>è®¾ç½® IR åç§°]

    style A fill:#fff3e0
    style D fill:#e8f5e9
    style E fill:#e3f2fd
```

**è½¬æ¢ç¤ºä¾‹:**

```python
# åŸå§‹ä»£ç 
@rewrite_assign
def decode(self, opcode):
    result = self.value == opcode
    return result

# è¢«è½¬æ¢ä¸º (æ¦‚å¿µä¸Š)
def decode(self, opcode):
    result = __assassyn_assignment__("result", self.value == opcode)
    return result
```

### 4.3 ä½¿ç”¨åœºæ™¯

åœ¨ `instructions.py` ä¸­å¯ä»¥çœ‹åˆ°å®é™…ä½¿ç”¨:

```python
@rewrite_assign
def decode(self, opcode, funct3, funct7, alu):
    view = self.view()
    opcode = view.opcode == Bits(7)(opcode)  # å˜é‡å "opcode" è¢«æ•è·
    funct3 = view.funct3 == Bits(3)(funct3)  # å˜é‡å "funct3" è¢«æ•è·
    funct7 = view.funct7 == Bits(7)(funct7)  # å˜é‡å "funct7" è¢«æ•è·

    # Python if: æ¡ä»¶ç¼–è¯‘
    if ex_code is not None:
        ex = view.rs2 == Bits(5)(ex_code)
    else:
        ex = Bits(1)(1)

    eq = opcode & funct3 & funct7 & ex
    return InstSignal(eq, alu)
```

---

## 5. å®ç”¨æŒ‡å—:ä½•æ—¶ä½¿ç”¨ `if` vs `Condition`

### 5.1 ä½¿ç”¨ Python `if` çš„åœºæ™¯

```python
# 1. æ ¹æ®å‚æ•°å†³å®šç¡¬ä»¶ç»“æ„
def build_alu(self, use_multiplier: bool):
    if use_multiplier:
        # ç”ŸæˆåŒ…å«ä¹˜æ³•å™¨çš„ç¡¬ä»¶
        result = a * b
    else:
        # ç”Ÿæˆä¸å«ä¹˜æ³•å™¨çš„ç¡¬ä»¶
        result = a + b

# 2. è°ƒè¯•ä»£ç çš„å¼€å…³
DEBUG = True
if DEBUG:
    log("Debug info: {}", value)

# 3. æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©å®ç°
if isinstance(value, int):
    const_val = UInt(32)(value)
else:
    const_val = value

# 4. å¯é€‰å­—æ®µçš„å¤„ç†
if field is not None:
    result = process(field)
```

### 5.2 ä½¿ç”¨ Assassyn `Condition` çš„åœºæ™¯

```python
# 1. ç¡¬ä»¶è¿è¡Œæ—¶æ¡ä»¶
enable = control_signal == Bits(1)(1)
with Condition(enable):
    register[0] = new_value

# 2. çŠ¶æ€æœºè½¬æ¢
is_idle = state == STATE_IDLE
with Condition(is_idle):
    state_next = STATE_ACTIVE

# 3. æ¡ä»¶æ—¥å¿—è¾“å‡º
valid_output = output > threshold
with Condition(valid_output):
    log("Output valid: {}", output)

# 4. æ¡ä»¶æ‰§è¡Œ
should_execute = counter < max_cycles
with Condition(should_execute):
    module.async_called(data=data)
```

### 5.3 å†³ç­–æµç¨‹å›¾

```{mermaid}
flowchart TD
    A[éœ€è¦æ¡ä»¶åˆ¤æ–­] --> B{æ¡ä»¶æ˜¯å¦åœ¨<br/>Python è¿è¡Œæ—¶å·²çŸ¥?}
    B -->|æ˜¯| C[ä½¿ç”¨ Python if]
    B -->|å¦| D{æ¡ä»¶ä¾èµ–äº<br/>ç¡¬ä»¶ä¿¡å·?}
    D -->|æ˜¯| E[ä½¿ç”¨ Condition]
    D -->|å¦| F[æ£€æŸ¥è®¾è®¡é€»è¾‘]

    C --> G[ç¤ºä¾‹:<br/>- ç¼–è¯‘é€‰é¡¹<br/>- å‚æ•°é…ç½®<br/>- None æ£€æŸ¥]
    E --> H[ç¤ºä¾‹:<br/>- è®¡æ•°å™¨æ¯”è¾ƒ<br/>- çŠ¶æ€æ£€æŸ¥<br/>- ä½¿èƒ½ä¿¡å·]

    style C fill:#fff3e0
    style E fill:#e3f2fd
```

---

## 6. å¸¸è§æ¨¡å¼å’Œæœ€ä½³å®è·µ

### 6.1 æ··åˆä½¿ç”¨æ¨¡å¼

```python
@rewrite_assign
def process(self, data, config_mode: int):
    # Python if: æ ¹æ®é…ç½®é€‰æ‹©ç®—æ³•
    if config_mode == 1:
        threshold = UInt(32)(100)
    elif config_mode == 2:
        threshold = UInt(32)(200)
    else:
        threshold = UInt(32)(50)

    # Condition: è¿è¡Œæ—¶åˆ¤æ–­
    is_valid = data < threshold
    with Condition(is_valid):
        log("Data {} is valid", data)
        result = data * UInt(32)(2)

    # Python if: å¯é€‰çš„é¢å¤–å¤„ç†
    if config_mode >= 2:
        with Condition(data > UInt(32)(0)):
            log("Extra check passed")
```

### 6.2 æ¡ä»¶åµŒå¥—

```python
# Python if å’Œ Condition çš„åµŒå¥—
FEATURE_ENABLED = True

@module.combinational
def build(self):
    counter = RegArray(UInt(32), 1)
    enable = counter[0] < UInt(32)(10)

    if FEATURE_ENABLED:  # Python if: å¤–å±‚
        with Condition(enable):  # Condition: å†…å±‚
            log("Feature active: {}", counter[0])

            if DEBUG_MODE:  # Python if: å†å†…å±‚
                log("Debug: enable={}", enable)
```

### 6.3 ç±»æ¯” C/C++ é¢„å¤„ç†

```c
// C/C++ çš„é¢„å¤„ç†æŒ‡ä»¤
#if DEBUG_MODE
    printf("Debug mode\n");
#else
    printf("Release mode\n");
#endif

// å¯¹åº” Python if (æ¡ä»¶ç¼–è¯‘)
DEBUG_MODE = True
if DEBUG_MODE:
    log("Debug mode")
else:
    log("Release mode")
```

```c
// C/C++ çš„è¿è¡Œæ—¶æ¡ä»¶
if (counter < threshold) {
    printf("Counter: %d\n", counter);
}

// å¯¹åº” Assassyn Condition (ç¡¬ä»¶æ¡ä»¶)
is_below = counter < threshold
with Condition(is_below):
    log("Counter: {}", counter)
```

---

## 7. æ€»ç»“

### 7.1 æ ¸å¿ƒè¦ç‚¹

1. **Trace-based DSL** é€šè¿‡è¿ç®—ç¬¦é‡è½½æ„å»º IR,æ‰§è¡Œ Python ä»£ç å³æ„å»ºç¡¬ä»¶æè¿°
2. **Python `if`** åœ¨ç¼–è¯‘æ—¶æ±‚å€¼,æ§åˆ¶ trace è·¯å¾„,å®ç°æ¡ä»¶ç¼–è¯‘
3. **Assassyn `Condition`** ç”Ÿæˆç¡¬ä»¶æ¡ä»¶é€»è¾‘,åœ¨ç¡¬ä»¶è¿è¡Œæ—¶æ±‚å€¼
4. **`@rewrite_assign`** é€šè¿‡ AST è½¬æ¢æ•è·å˜é‡å,å®ç°è¯­ä¹‰åŒ–å‘½å
5. ä¸¤ç§æ–¹å¼å¯ä»¥æ··åˆä½¿ç”¨,æ ¹æ®æ¡ä»¶çš„æ±‚å€¼æ—¶æœºé€‰æ‹©åˆé€‚çš„æ–¹å¼

### 7.2 ç±»æ¯”æ€»ç»“è¡¨

| Assassyn | C/C++ | Verilog | æ±‚å€¼æ—¶æœº |
|----------|-------|---------|---------|
| Python `if` | `#if` | æ—  (å‚æ•°åŒ–) | ç¼–è¯‘æ—¶ |
| `Condition` | `if` | `if` | è¿è¡Œæ—¶ |
| `@rewrite_assign` | æ—  | æ—  | ç¼–è¯‘æ—¶ (AST) |


## 8. è¿›ä¸€æ­¥é˜…è¯»

- [docs/design/lang/trace.md](../docs/design/lang/trace.md) - Trace-based DSL è®¾è®¡æ–‡æ¡£
- [docs/design/lang/dsl.md](../docs/design/lang/dsl.md) - DSL æ¦‚å¿µæ€»è§ˆ
- [python/assassyn/builder/rewrite_assign.md](../python/assassyn/builder/rewrite_assign.md) - `@rewrite_assign` å®ç°ç»†èŠ‚
- [python/assassyn/ir/block.md](../python/assassyn/ir/block.md) - `Condition` å’Œ `Block` çš„å®ç°
- [examples/minor-cpu/src/decoder.py](../examples/minor-cpu/src/decoder.py) - å®é™…é¡¹ç›®ä¸­çš„ä½¿ç”¨ç¤ºä¾‹

---
