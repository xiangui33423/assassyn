# Nested For-Loop FSM Template

> **å¯å¤ç”¨çš„åµŒå¥—å¾ªç¯çŠ¶æ€æœºæ¨¡æ¿ï¼Œæ”¯æŒæ¡æ‰‹åè®®çš„å†…å±‚è®¡ç®—å•å…ƒ**

---

## ğŸ“– é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªé€šç”¨çš„**åµŒå¥—forå¾ªç¯çŠ¶æ€æœºæ¨¡æ¿**ï¼Œç”¨äºåœ¨ Assassyn ç¡¬ä»¶æè¿°è¯­è¨€ä¸­å®ç°å¾ªç¯æ§åˆ¶é€»è¾‘ã€‚è¯¥æ¨¡æ¿å°†å¾ªç¯æ§åˆ¶ä¸è®¡ç®—é€»è¾‘è§£è€¦ï¼Œé€šè¿‡æ¡æ‰‹åè®®ï¼ˆready/valid/doneï¼‰å®ç°ä¸¤è€…çš„ååŒå·¥ä½œã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **æ¨¡å—åŒ–è®¾è®¡**: åˆ†ç¦»å¾ªç¯æ§åˆ¶å™¨ï¼ˆOuterLoopFSMï¼‰å’Œè®¡ç®—å•å…ƒï¼ˆInnerComputeFSMï¼‰
- âœ… **æ¡æ‰‹åè®®**: ä½¿ç”¨ ready/valid/done ä¿¡å·å®ç°å¯é çš„åŒæ­¥
- âœ… **å¤šå‘¨æœŸè®¡ç®—æ”¯æŒ**: å†…å±‚FSMå¯æ‰§è¡Œä»»æ„å‘¨æœŸæ•°çš„å¤æ‚è®¡ç®—
- âœ… **å£°æ˜å¼çŠ¶æ€æœº**: åŸºäº Assassyn FSM æŠ½è±¡ï¼Œæ¸…æ™°æ˜“æ‡‚
- âœ… **å¯å‚æ•°åŒ–**: æ”¯æŒæ•°æ®ä½å®½ã€å¾ªç¯è¾¹ç•Œçš„çµæ´»é…ç½®
- âœ… **å¯æ‰©å±•**: æ˜“äºæ‰©å±•åˆ°å¤šå±‚åµŒå¥—æˆ–å¹¶è¡Œè®¡ç®—

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          OuterLoopFSM (å¤–å±‚å¾ªç¯æ§åˆ¶å™¨)        â”‚
â”‚                                             â”‚
â”‚  init â†’ wait_ready â†’ execute â†’ check_done  â”‚
â”‚          â†‘                           â†“      â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Handshake Signals
                    â”‚ â€¢ inner_ready
                    â”‚ â€¢ outer_valid
                    â”‚ â€¢ inner_done
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       InnerComputeFSM (å†…å±‚è®¡ç®—å•å…ƒ)         â”‚
â”‚                                             â”‚
â”‚  idle â†’ compute â†’ done â†’ reset â†’ (idle)    â”‚
â”‚   â†‘                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¡æ‰‹åè®®æ—¶åº

```
Cycle:      0    1    2    3    4    5    6
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
OuterFSM:   init wait exec chk  wait exec ...
InnerFSM:   idle      cpt  cpt done rst  idle

inner_ready: â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€
               â””â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”˜

outer_valid: â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
               â””â”€â”˜          â””â”€â”˜

inner_done:  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€
                       â””â”€â”˜          â””â”€â”˜
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
examples/nested-loop-fsm/
â”œâ”€â”€ README.md                    # é¡¹ç›®ä»‹ç»ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ SPEC.md                      # è¯¦ç»†è§„èŒƒæ–‡æ¡£
â”œâ”€â”€ basic_example.py             # åŸºç¡€ç¤ºä¾‹ï¼šç®€å•ç´¯åŠ å¾ªç¯
â”œâ”€â”€ multi_cycle_example.py       # å¤šå‘¨æœŸç¤ºä¾‹ï¼šç§»ä½ä¹˜æ³•å™¨
â””â”€â”€ test_nested_loop_fsm.py      # å•å…ƒæµ‹è¯•
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

- å·²å®‰è£… Assassyn ç¯å¢ƒ
- å·²æ‰§è¡Œ `source setup.sh`

### è¿è¡ŒåŸºç¡€ç¤ºä¾‹

```bash
cd examples/nested-loop-fsm
python basic_example.py
```

è¯¥ç¤ºä¾‹å®ç°äº†ä¸€ä¸ªç®€å•çš„ç´¯åŠ å¾ªç¯ï¼š
```
sum = 0 + 1 + 2 + ... + 99 = 4950
```

### ä»£ç ç¤ºä¾‹

```python
from assassyn.frontend import *
from assassyn.ir.module import fsm

# å®šä¹‰å†…å±‚è®¡ç®—FSMï¼ˆç´¯åŠ å™¨ï¼‰
class SimpleAccumulator(Module):
    def __init__(self):
        super().__init__(
            ports={
                'iteration': Port(UInt(32)),
                'valid': Port(Bits(1)),
            }
        )

    @module.combinational
    def build(self, ready_out, done_out):
        iteration, valid = self.pop_all_ports(True)

        # çŠ¶æ€æœºå®šä¹‰...
        # è¯¦è§ basic_example.py

# å®šä¹‰å¤–å±‚å¾ªç¯FSMï¼ˆæ§åˆ¶å™¨ï¼‰
class OuterLoopController(Module):
    def __init__(self):
        super().__init__(ports={})

    @module.combinational
    def build(self, inner_fsm, loop_start, loop_end, loop_step):
        # åˆ›å»ºæ¡æ‰‹ä¿¡å·
        inner_ready = RegArray(Bits(1), 1, initializer=[1])
        inner_done = RegArray(Bits(1), 1, initializer=[0])

        # è°ƒç”¨å†…å±‚FSM
        result = inner_fsm.build(inner_ready, inner_done)

        # å¤–å±‚FSMé€»è¾‘...
        # è¯¦è§ basic_example.py

        return result

# åœ¨Driverä¸­ä½¿ç”¨
class Driver(Module):
    @module.combinational
    def build(self):
        accumulator = SimpleAccumulator()
        controller = OuterLoopController()

        result = controller.build(
            inner_fsm=accumulator,
            loop_start=UInt(32)(0),
            loop_end=UInt(32)(100),
            loop_step=UInt(32)(1)
        )
```

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

### [SPEC.md](./SPEC.md) - å®Œæ•´è§„èŒƒæ–‡æ¡£

åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
1. **è®¾è®¡åŠ¨æœºä¸ç›®æ ‡**
2. **æ¶æ„æ¦‚è¿°** - åŒå±‚FSMå±‚æ¬¡ç»“æ„
3. **å¤–å±‚å¾ªç¯FSMè§„èŒƒ** - çŠ¶æ€å®šä¹‰ã€æ¥å£ã€è¡Œä¸º
4. **å†…å±‚è®¡ç®—FSMè§„èŒƒ** - çŠ¶æ€å®šä¹‰ã€æ¥å£ã€è¡Œä¸º
5. **æ¡æ‰‹åè®®è§„èŒƒ** - ä¿¡å·å®šä¹‰ã€æ—¶åºè¦æ±‚
6. **ä½¿ç”¨ç¤ºä¾‹** - åŸºç¡€å¾ªç¯ã€å¤šå‘¨æœŸè®¡ç®—
7. **å®ç°è€ƒè™‘** - å‚æ•°åŒ–ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–
8. **æœªæ¥æ‰©å±•** - å¤šå±‚åµŒå¥—ã€åŠ¨æ€è¾¹ç•Œã€å¹¶è¡ŒåŒ–

---

## ğŸ”§ ä½¿ç”¨åœºæ™¯

### é€‚ç”¨åœºæ™¯

- âœ… ç¡¬ä»¶åŠ é€Ÿå™¨ä¸­çš„å¾ªç¯ç»“æ„å®ç°
- âœ… éœ€è¦å¤šå‘¨æœŸè®¡ç®—çš„è¿­ä»£ç®—æ³•
- âœ… æµå¤„ç†ä¸­çš„æ‰¹é‡æ•°æ®å¤„ç†
- âœ… ç¥ç»ç½‘ç»œå±‚çš„å¾ªç¯è®¡ç®—ï¼ˆå¦‚å·ç§¯ã€çŸ©é˜µä¹˜æ³•ï¼‰

### ç¤ºä¾‹åº”ç”¨

1. **å‘é‡ç‚¹ç§¯è®¡ç®—**
   - å¤–å±‚FSM: éå†å‘é‡å…ƒç´ 
   - å†…å±‚FSM: æ‰§è¡Œä¹˜æ³•ç´¯åŠ ï¼ˆå¯èƒ½éœ€è¦å¤šå‘¨æœŸï¼‰

2. **çŸ©é˜µè½¬ç½®**
   - å¤–å±‚FSM: éå†è¡Œ/åˆ—ç´¢å¼•
   - å†…å±‚FSM: æ‰§è¡Œå†…å­˜è¯»å†™æ“ä½œ

3. **å›¾åƒå·ç§¯**
   - å¤–å±‚FSM: éå†è¾“å‡ºåƒç´ ä½ç½®
   - å†…å±‚FSM: è®¡ç®—å·ç§¯çª—å£å†…çš„ä¹˜åŠ è¿ç®—

4. **æ’åºç®—æ³•**
   - å¤–å±‚FSM: æ§åˆ¶æ’åºè½®æ¬¡
   - å†…å±‚FSM: æ‰§è¡Œå•è½®æ¯”è¾ƒäº¤æ¢

---

## ğŸ§ª æµ‹è¯•

è¿è¡Œå•å…ƒæµ‹è¯•ï¼š

```bash
pytest test_nested_loop_fsm.py -v
```

æµ‹è¯•è¦†ç›–ï¼š
- âœ… åŸºç¡€å¾ªç¯åŠŸèƒ½
- âœ… æ¡æ‰‹ä¿¡å·æ­£ç¡®æ€§
- âœ… å¤šå‘¨æœŸè®¡ç®—
- âœ… è¾¹ç•Œæ¡ä»¶ï¼ˆç©ºå¾ªç¯ã€å•æ¬¡è¿­ä»£ï¼‰
- âœ… ä¸åŒæ­¥é•¿çš„å¾ªç¯

---

## ğŸ¯ è®¾è®¡æ¨¡å¼

### 1. å•å‘¨æœŸè®¡ç®—æ¨¡å¼

**é€‚ç”¨**: å†…å±‚è®¡ç®—å¯åœ¨ä¸€ä¸ªå‘¨æœŸå†…å®Œæˆ

```python
# å†…å±‚FSMçŠ¶æ€è½¬ç§»
idle â†’ compute â†’ done â†’ reset â†’ idle
  1      1        1      1     (cycles)
```

**ç¤ºä¾‹**: ç®€å•ç®—æœ¯è¿ç®—ï¼ˆåŠ æ³•ã€ä½è¿ç®—ï¼‰

### 2. å¤šå‘¨æœŸè®¡ç®—æ¨¡å¼

**é€‚ç”¨**: å†…å±‚è®¡ç®—éœ€è¦å¤šä¸ªå‘¨æœŸ

```python
# å†…å±‚FSMçŠ¶æ€è½¬ç§»
idle â†’ compute â†’ ... â†’ compute â†’ done â†’ reset â†’ idle
  1      1       ...      1      1      1
```

**ç¤ºä¾‹**: è¿­ä»£ç®—æ³•ï¼ˆé™¤æ³•ã€å¹³æ–¹æ ¹ã€ä¹˜æ³•å™¨ï¼‰

### 3. æ•°æ®ä¾èµ–æ¨¡å¼

**é€‚ç”¨**: è®¡ç®—å‘¨æœŸæ•°ä¾èµ–äºæ•°æ®

```python
# å†…å±‚FSMæ ¹æ®æ•°æ®åŠ¨æ€å†³å®šä½•æ—¶å®Œæˆ
with Condition(result_meets_criteria):
    state = "done"
```

**ç¤ºä¾‹**: æ”¶æ•›ç®—æ³•ã€æœç´¢ç®—æ³•

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æ·»åŠ æ—¥å¿—è¾“å‡º

åœ¨çŠ¶æ€åŠ¨ä½œä¸­æ·»åŠ  `log()` è¯­å¥ï¼š

```python
def execute_action():
    log("OuterFSM: iter={}, ready={}, valid={}",
        loop_counter[0], inner_ready[0], outer_valid[0])
```

### 2. æ£€æŸ¥æ¡æ‰‹ä¿¡å·

éªŒè¯æ¡æ‰‹åè®®çš„æ­£ç¡®æ€§ï¼š

```python
# éæ³•çŠ¶æ€æ£€æµ‹
with Condition((inner_ready[0] == Bits(1)(1)) &
               (inner_done[0] == Bits(1)(1))):
    log("ERROR: Invalid handshake!")
```

### 3. æ·»åŠ è¶…æ—¶ä¿æŠ¤

é˜²æ­¢æ­»é”ï¼š

```python
timeout_counter = RegArray(UInt(16), 1, initializer=[0])

def check_done_action():
    timeout_counter[0] = timeout_counter[0] + UInt(16)(1)
    with Condition(timeout_counter[0] > UInt(16)(1000)):
        log("ERROR: Timeout waiting for inner_done!")
```

---

## ğŸ› ï¸ è‡ªå®šä¹‰æ‰©å±•

### æ‰©å±•å†…å±‚è®¡ç®—é€»è¾‘

```python
class CustomComputeFSM(Module):
    @module.combinational
    def build(self, ready_out, done_out):
        # 1. å®šä¹‰ä½ çš„è®¡ç®—å¯„å­˜å™¨
        custom_reg = RegArray(UInt(64), 1, initializer=[0])

        # 2. å®šä¹‰ä½ çš„å®Œæˆæ¡ä»¶
        compute_done = (custom_condition)

        # 3. å®ç° compute_action
        def compute_action():
            # ä½ çš„è®¡ç®—é€»è¾‘
            custom_reg[0] = custom_computation(iteration)

        # 4. ç”ŸæˆFSM...
```

### æ·»åŠ é¢å¤–çš„æ¡æ‰‹ä¿¡å·

```python
# ä¾‹å¦‚ï¼šæ·»åŠ é”™è¯¯ä¿¡å·
error_out = RegArray(Bits(1), 1, initializer=[0])

def compute_action():
    with Condition(error_condition):
        error_out[0] = Bits(1)(1)
        # è·³è½¬åˆ°é”™è¯¯å¤„ç†çŠ¶æ€
```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å»¶è¿Ÿï¼ˆLatencyï¼‰

- **æ¯æ¬¡è¿­ä»£å»¶è¿Ÿ** = æ¡æ‰‹å¼€é”€ (4 cycles) + å†…å±‚è®¡ç®—å‘¨æœŸ
  - 1 cycle: wait_ready
  - 1 cycle: execute
  - N cycles: compute
  - 1 cycle: done
  - 1 cycle: reset

### ååé‡ï¼ˆThroughputï¼‰

- **å•ä¸ªå†…å±‚FSM**: 1 / (4 + N) iterations/cycle
- **ä¼˜åŒ–**: ä½¿ç”¨å¤šä¸ªå¹¶è¡Œå†…å±‚FSMå¯æé«˜ååé‡

### èµ„æºä½¿ç”¨

- **å¤–å±‚FSM**: ~100 LUTs, ~50 FFs
- **å†…å±‚FSM**: å–å†³äºè®¡ç®—é€»è¾‘å¤æ‚åº¦
- **æ¡æ‰‹ä¿¡å·**: 3 FFs

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼

---

## ğŸ“„ è®¸å¯è¯

éµå¾ª Assassyn é¡¹ç›®è®¸å¯è¯ã€‚

---

## ğŸ”— ç›¸å…³èµ„æº

- [Assassyn æ–‡æ¡£](../../../docs/)
- [Assassyn FSM æ¨¡å—æ–‡æ¡£](../../../python/assassyn/ir/module/fsm.md)
- [å¼‚æ­¥è°ƒç”¨æ•™ç¨‹](../../../tutorials/01_async_call_en.qmd)
- [Radix Sort FSM ç¤ºä¾‹](../radix_sort/main_fsm.py)

---

**Happy Coding! ğŸš€**
